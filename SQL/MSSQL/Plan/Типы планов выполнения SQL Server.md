В предыдущей статье мы подробно описали различные этапы, через которые проходит отправленный SQL-запрос и как его обрабатывает SQL Server Relational Engine. SQL Server Relational Engine генерирует план выполнения, а SQL Server Storage Engine выполняет запрошенный процесс извлечения или изменения данных. В этой статье мы рассмотрим различные типы и форматы планов выполнения SQL Server.

## Типы планов выполнения

План выполнения (**Execution Plan**) SQL Server — это графическое представление плана выполнения отправленного запроса, за которым будет следовать оптимизатор запросов SQL Server, со стоимостью выполнения каждой части кода запроса. SQL Server предоставляет нам два основных типа планов выполнения.

- Первый тип — предполагаемый план выполнения (**Estimated Execution Plan**). Это план, который создается путем анализа отправленного запроса в качестве оценки того, как запрос будет выполняться без выполнения.
- Второй тип — это фактический план выполнения (**Actual Execution Plan**), который создается путем выполнения отправленного запроса и отображает фактические шаги, которые следовали при выполнении запроса.

Фактические планы выполнения в большинстве случаев предпочитают администраторы баз данных, поскольку они показывают больше информации о статистике выполнения запросов. Вы можете извлечь выгоду из предполагаемого плана выполнения при устранении неполадок в сложных запросах, выполнение которых занимает много времени, где вы сможете создать план выполнения без необходимости его выполнения. Но в некоторых случаях предполагаемый и фактический планы выполнения могут сильно отличаться из-за разницы между фактическими данными таблицы и статистикой. Частые операции вставки и изменения данных также могут сделать статистику менее точной.

Эту проблему можно устранить, обновив статистику таблицы или индекса. В некоторых ситуациях предполагаемый план выполнения не может быть сгенерирован, если запрос содержит временную таблицу, которая еще не создана, поскольку запрос не выполняется для создания таблицы, что приводит к появлению сообщения об ошибке, подобного приведенному ниже:

![[Plan_5.png]]

Предполагаемый план выполнения можно просмотреть по-разному:

- Выберите параметр **«Показать расчетный план выполнения»** (**Display Estimated Execution Plan**) в меню **«Запрос»** , как показано ниже:
   
   ![[Plan_6.png]]
   
- Щелкните значок **«Отобразить предполагаемый план выполнения»** (**Display Estimated Execution Plan**) на панели задач следующим образом:

![[Plan_7.png]]

- Щелкните правой кнопкой мыши редактор запросов и выберите параметр **«Показать расчетный план выполнения»** (**Display Estimated Execution Plan**) , как показано ниже:

![[Plan_8.png]]

- Введите сочетание клавиш **Ctrl+L** , и предполагаемый план выполнения для отправленного запроса будет отображаться без необходимости его выполнения, как на снимке ниже:

![[Plan_9.png]]

Фактический план выполнения, в отличие от предполагаемого плана выполнения, не может отображаться напрямую. Для отображения требуется, чтобы отправленный запрос был выполнен. Фактический план выполнения может быть включен в запрос разными способами:

- Выберите параметр «Включить **фактический план выполнения»** (**Actual Execution Plan**) в меню «Запрос», как показано ниже:

![[Plan_10.png]]

- Щелкните значок **«Включить фактический план выполнения»** (**Actual Execution Plan**) на панели задач следующим образом:

![[Plan_11.png]]

- Щелкните правой кнопкой мыши редактор запросов и выберите параметр **«Включить фактический план выполнения»** (**Actual Execution Plan**), как показано ниже:

![[Plan_12.png]]

- Введите сочетание клавиш **Ctrl+M** , и фактический план выполнения для отправленного запроса будет включен. Другими словами, опция Actual Execution Plan будет включена для этого запроса или любого запроса, выполняемого в этом окне. При выполнении запроса будет отображаться Фактический план выполнения, как на снимке ниже:

![[Plan_13.png]]

For more information about the Actual and Estimated Execution Plans, check [SQL Server Estimated Vs Actual Execution Plans](https://www.sqlshack.com/sql-server-estimated-vs-actual-execution-plans/).

В SQL Server 2016 Microsoft представила новую функцию, которая дает нам возможность отслеживать статистику времени выполнения, также называемую Live **Execution Statistics** , для каждого оператора в плане выполнения и отслеживать поток данных между различными операторами во время выполнения. процесс выполнения запроса. Статистика выполнения включает количество обработанных строк, время, затраченное каждым оператором, и общий ход выполнения запроса.

Live Query Statistics можно включить разными способами:

- Выберите параметр **«Включить статистику запросов в реальном времени»** (**Include Live Query Statistics**) в меню **«Запрос»** , как показано ниже:

![[Plan_14.png]]

- Щелкните значок **«Включить статистику запросов в реальном времени»** (**Include Live Query Statistics**) на панели задач следующим образом:

![[Plan_15.png]]

- Щелкните правой кнопкой мыши редактор запросов и выберите параметр **«Включить статистику оперативных запросов»** (**Include Live Query Statistics**) , как показано ниже:

![[Plan_16.png|center]]

- Откройте окно Activity Monitor и щелкните правой кнопкой мыши целевой запрос в разделе Active Expensive Queries, затем выберите параметр **Show Live Execution Plan** , как показано ниже:

![[Plan_17.png]]

 После включения Live Query Statistics запустите запрос и отслеживайте статистику выполнения запроса во время выполнения и то, как данные передаются между операторами, как показано ниже:

![[plan_18.gif]]

Дополнительные сведения о новой функции Live Query Statistics см. в статье [Устранение неполадок с производительностью SQL-запросов с помощью SQL Server 2016 Live Execution Statistics](https://www.sqlshack.com/troubleshoot-query-performance-using-sql-server-2016-live-execution-statistics/) .

## Форматы планов выполнения

В SQL Server план выполнения, созданный для каждого запроса, можно просмотреть тремя различными способами, в зависимости от уровня детализации, который вы можете просмотреть, и метода создания плана. Три формата плана выполнения:

- **Графический формат** :
    
    Графическое представление плана выполнения SQL Server является наиболее распространенным и удобным форматом плана, который дает нам быстрый и простой способ прочитать план и проанализировать его. Графические представления включают планы Фактическая, Расчетная и Текущая статистика запросов, которые обсуждались ранее в этой статье. Единственная темная сторона графического формата плана выполнения заключается в том, что детали выполнения скрыты за стрелками плана и свойствами операторов, как показано ниже:
    
    

- **Текстовый формат** :
    
    Текстовый план немедленно предоставляет нам наименьшие подробности о выполнении запроса в плоском текстовом представлении, что делает его довольно сложным для анализа и нежелательным для администраторов базы данных.
    
    Текстовый план поставляется в трех форматах:
    
    - **SET SHOWPLAN_ALL** : отображает предполагаемый план запроса с полным набором информации о выполнении запроса, как показано ниже:
        
        ![[Plan_20.png]]
        
    - **SET SHOWPLAN_TEXT** : отображает предполагаемый план запроса с очень ограниченным набором информации о выполнении запроса, как показано ниже:
        
        ![[Plan_21.png]]
        
    - **SET STATISTICS PROFILE** : отображает фактический план выполнения запроса с полным набором сведений, как показано ниже (см., как отображаются результаты запроса):
        
        ![[Plan_22.png]]

- **Формат XML** :
    
    План XML предоставляет нам полный набор информации о выполнении запроса, представленной в структуре XML, которую трудно прочитать и проанализировать и которой легко поделиться с другими экспертами в целях устранения неполадок.
    
    План выполнения XML поставляется в двух форматах:
    
    - **SHOWPLAN_XML** : отображает предполагаемый план выполнения запроса, как показано ниже (напомним, что вы можете легко получить план XML из графического плана, используя параметр «Показать XML-план выполнения»):
        
        ![[Plan_23.png]]
        
    - **STATISTICS XML** : отображает фактический план выполнения запроса, как показано ниже:
        
        ![[Plan_24.png]]
        

К этому моменту мы познакомились с различными типами и форматами планов выполнения SQL Server, различиями между этими типами и форматами и тем, как мы можем извлечь выгоду из этих типов. Следите за следующей статьей, в которой мы обсудим различные компоненты плана выполнения и способы его анализа.