## Анализ поведения запросов Using Execution Plans ("Использование планов выполнения")  
  
Планы выполнения - это лучшее средство для понимания того, что выбирает оптимизатор запросов, пытаясь обеспечить высокую скорость выполнения запроса. Планы выполнения точно описывают поведение запроса, начиная с типов операций объединения и заканчивая используемыми индексами, а также способы их использования. Планы выполнения не являются абсолютным показателем производительности. Это должно быть предельно ясно.  
В этой главе мы расскажем о том, что такое планы выполнения, как они выглядят и как их читать. Для этого мы рассмотрим следующие темы:  
  
- Как захватывать планы выполнения  
- Разница между Actual("фактический") и Estimated("предполагаемый") планами  
- Что следует искать в планах выполнения  
- Что означают некоторые операторы  
- Доступные инструменты, помогающие в работе с планами выполнения

Планы выполнения - это обширная тема. В этой главе я расскажу о некоторых особенностях их использования, а затем буду использовать их на протяжении всей книги, когда мы будем учиться настраивать запросы с помощью понимания поведения, демонстрируемого планами выполнения.  
  
Сами планы выполнения являются общими для всех платформ данных SQL Server. План, созданный в Azure SQL Database, SQL Server 2022, AWS RDS или Azure Managed Instance, будет таким же, как и любой другой. Это делает их универсальным инструментом для понимания поведения запросов.

## Предполагаемые или Фактические Планы Выполнения  
  
Давайте начнем с самой актуальной темы и разберемся с ней. В следующем разделе я расскажу о методах, используемых для получения планов выполнения. Одним из таких способов является использование SQL Server Management Studio (SSMS). SSMS показывает нам два различных вида планов: Estimated("предполагаемый") и Actual("фактический"). Проблема в том, что это неточные названия. Существует только один вид плана выполнения. Однако можно запустить запрос и заставить SQL Server зафиксировать определенные метрики времени работы в плане выполнения этого запроса. Именно этот план выполнения с добавлением метрик рабочего времени и называется "фактическим планом выполнения".  
Это противоречит многолетней документации, в том числе и той, которую я написал сам. Однако это абсолютно верно. Как мы увидим в следующем разделе и на протяжении всей книги, мы будем получать планы выполнения из самых разных источников: из Dynamic Management Views("Представления Динамического Управления"), Extended Events, Query Store и других. Все эти планы для данного запроса без перекомпиляции будут идентичны. Однако если мы выполним запрос и снимем метрики во время выполнения, то этот план также будет идентичным. Он просто будет содержать дополнительную информацию.

Добавленная информация, а именно метрики рабочего времени, - это отличные данные, и мы собираемся их использовать. Эта информация включает, но не ограничивается следующим:  
  
- Статистика ожидания для запроса  
- Длительность запроса  
- Фактическое количество строк  
- Фактическое количество выполненных операторов  
  
Однако это лишь дополнительные данные. Сам план всегда один и тот же (за исключением случаев перекомпиляции, которые мы подробно рассмотрим в главе 14). Чаще всего, если есть возможность, старайтесь фиксировать план выполнения с помощью метрик времени выполнения. Дополнительная информация часто оказывается полезной. Однако, поскольку в рабочей среде иногда не удается выполнить запросы не стесняйтесь использовать план выполнения не содержащий метрик времени выполнения. Это может быть единственным доступным инструментом.

## Захват Планов Выполнения  
  
Существует несколько методов захвата планов выполнения. Самый простой - использовать SSMS для получения плана выполнения без выполнения запроса или плана выполнения с метрикой времени работы после выполнения запроса. Можно также извлекать запросы непосредственно из кэша плана в памяти с помощью DMV. Если для данной базы данных включен Query Store, то в нем также будут содержаться планы выполнения. Наконец, для получения различных планов выполнения можно использовать Extended Events.  
Прежде чем мы приступим к рассмотрению деталей, несколько замечаний о захвате планов выполнения. Захват метрик времени выполнения с планом выполнения является дорогостоящей операцией. Кроме того, этот процесс будет напрямую и негативно влиять на время выполнения запроса и использование ресурсов. В связи с этим следует взять за привычку либо перехватывать план выполнения, либо перехватывать метрики времени выполнения. Не стоит делать и то, и другое одновременно.  
За графическим планом выполнения, который мы будем использовать на протяжении всей книги, находится XML. Именно так он хранится в памяти, в Query Store, и так он будет у большинства методов получения плана. Существует способ получения так называемого "текстового плана", но он не так полезен, поэтому здесь мы его рассматривать не будем.  
Наконец, существует способ захвата плана в Azure Data Studio. Однако на момент написания этой статьи планы в ней были крайне неполными, поэтому мы не будем их здесь использовать.

## SQL Server Management Studio 

В SSMS можно захватить план выполнения, а можно выполнить запрос и получить как план выполнения, так и метрики времени выполнения. В качестве примера возьмем простой запрос, который мы будем использовать на протяжении всей главы, чтобы не публиковать графический план более одного раза. В листинге 4-1 показан наш пример запроса.

Листинг 4-1. Простой запрос для иллюстрации планов выполнения

```sql
SELECT 
	soh.SalesOrderNumber, 
	p.Name, 
	sod.OrderQty 
FROM Sales.SalesOrderHeader AS soh 
	JOIN Sales.SalesOrderDetail AS sod ON sod.SalesOrderID = soh.SalesOrderID
	JOIN Production.Product AS p ON p.ProductID = sod.ProductID 
WHERE soh.CustomerID = 30052;
```

Чтобы увидеть план выполнения мы нажмем кнопку на панели инструментов SQL Editor. Однако перед этим необходимо выделить запрос из Листинга 4-1. В пакетной обработке каждый запрос получает свой план выполнения. Поэтому, если мы хотим видеть только один план выполнения, выделите этот текст. В противном случае будет получен план для каждого запроса в пакете.  
Кнопка, которую мы собираемся нажать после выделения нашего запроса, показана на рис. 4-1 с рамкой вокруг нее. Она также имеет всплывающую подсказку: "Отобразить предполагаемый план выполнения".

![[Figure 4-1.png]]

Рисунок 4-1. Панель инструментов SQL Editor с выделенной кнопкой Display estimated execution plan

Это же действие можно выполнить с помощью клавиатуры, набрав CTL-L. После нажатия кнопки или сочетания клавиш вы сразу же увидите план выполнения на отдельной вкладке в панели результатов в окне запроса SSMS, как показано на рис. 4-2.

![[Figure 4-2.png]]

Рисунок 4-2. Выделенный запрос и план его выполнения

Мы рассмотрим объекты называемые операторами в плане выполнения позже в этой главе. На данный момент вы получили свой первый план выполнения.

Чтобы добавить метрики времени выполнения в план, мы должны выполнить запрос, но для этого необходимо сделать одно действие. Мы должны включить возможность захвата метрик времени выполнения с помощью другой кнопки на панели инструментов SQL Editor, выделенной на рисунке 4-3 в положении on.

![[Figure 4-3.png]]

Рисунок 4-3. Панель инструментов SQL Editor с выделенной кнопкой Include actual execution plan

В подсказке к кнопке написано "Включить реальный план выполнения". Включить или выключить ее можно также с клавиатуры, набрав CTL-M. В отличие от первого плана выполнения, здесь ничего не происходит, кроме того, что кнопка отображается в нажатом состоянии. Опять же, чтобы увидеть план выполнения и метрики времени выполнения, необходимо выполнить запрос. После выполнения запроса в панели результатов появится та же вкладка Execution plan (План выполнения), как показано на рис. 4-4. Однако вкладка результатов будет открыта по умолчанию, поэтому для просмотра плана выполнения необходимо щелкнуть на этой вкладке.

![[Figure 4-4.png]]

Рисунок 4-4. План выполнения с метриками времени выполнения

Видно, что, хотя основная форма плана и количество объектов в нем остались прежними, была добавлена дополнительная информация. Эта дополнительная информация - метрики времени выполнения, добавленные к каждому оператору в плане.

Dynamic Management Views("Представления Динамического Управления")  
  
В главе 3 мы уже рассказывали о захвате планов выполнения с помощью DMV на приведенных там примерах. Тем не менее, нам следует немного расширить эту тему. Во-первых, давайте добавим к нашему запросу из главы 3 предложение WHERE, чтобы можно было найти только тот запрос, который выполняется в данный момент.  
В листинге 4-2 показано предложение WHERE.

Листинг 4-2. Фильтрация по определенному запросу

```sql
SELECT 
	dest.text, 
	deqp.query_plan, 
	deqs.execution_count, 
	deqs.total_elapsed_time, 
	deqs.last_elapsed_time 
FROM sys.dm_exec_query_stats AS deqs 
	CROSS APPLY sys.dm_exec_query_plan(deqs.plan_handle) AS deqp 
	CROSS APPLY sys.dm_exec_sql_text(deqs.sql_handle) AS dest 
WHERE 
	dest.text LIKE 'SELECT soh.SalesOrderNumber, p.Name, %';
```

 Использование оператора LIKE позволяет сохранить немного пространства в книге. Для получения данных из систем, вероятно, лучше использовать оператор равно и предоставить запрос целиком. Результаты показаны на рис. 4-5.

![[Figure 4-5.png]]

Рисунок 4-5. Результаты запроса к кэшу планов с помощью DMV

Обратите внимание, что в столбце query_plan отображаются XML-данные, но при этом они 
подчеркнуты. Это связано с тем, что если щелкнуть на нем, то система распознает, что это 
план выполнения и откроет его в другом окне запроса. Большинство планов можно 
получить таким образом. Однако, открыв их, вы увидите только план выполнения. Метрики 
времени выполнения не отображаются, поскольку они не хранятся в кэше планов.  

Не все планы будут работать таким образом. Поскольку тип данных XML в SQL Server имеет 
ограничение по вложенности, некоторые планы выполнения очень больших и сложных 
запросов могут его превысить. В связи с этим в SQL Server также имеется DMV под 
названием sys.dm_exec_text_query_plan. Запрос к нему выполняется так же, как и к 
sys.dm_exec_query_plan, с указанием значения plan_handle. Результаты выдаются в виде 
текста, а не XML. Чтобы преобразовать его в графический план выполнения, необходимо 
сохранить текст в файл *.sqlplan, а затем открыть его в SSMS. 

Для получения последнего фактического плана запроса в кэше имеется еще один DMV - 
sys.dm_exec_query_plan_stats. Однако для использования этой функции необходимо включить 
профилирование облегченной статистики, установив флаг трассировки 2451 на уровне 
сервера или используя Листинг 4-3 на уровне базы данных.

```SQL
ALTER DATABASE SCOPED CONFIGURATION SET LAST_QUERY_PLAN_STATS = ON;
```

После этого DMV будет хранить последний план выполнения с метриками времени 
выполнения. Теперь я могу переписать запрос из листинга 4-2, чтобы использовать эту DMV, 
как показано в листинге 4-4.

Листинг 4-4. Запрос DMV sys.dm_exec_query_plan_stats

```sql
SELECT 
	dest.text, 
	deqp.query_plan, 
	deqs.execution_count, 
	deqs.total_elapsed_time, 
	deqs.last_elapsed_time 
FROM sys.dm_exec_query_stats AS deqs 
	CROSS APPLY sys.dm_exec_query_plan_stats(deqs.plan_handle) AS deqp 
	CROSS APPLY sys.dm_exec_sql_text(deqs.sql_handle) AS dest 
WHERE 
	dest.text LIKE 'SELECT soh.SalesOrderNumber, p.Name, %';
```

Если я щелкну на плане в результатах, то откроется план выполнения плюс метрики времени выполнения, как показано на рис. 4-6.

![[Figure 4-6.png]]

Рисунок 4-6. План выполнения с метриками

Вы видите, как в нем подсчитываются фактические количества строк. Вы также найдете все 
стандартные метрики выполнения. При этом получение плана не гарантировано. Во-первых, 
план должен находиться в sys.dm_exec_cached_plans, иначе он вообще не будет доступен. 
Кроме того, если запрос очень простой, то вместо полного плана вы можете получить 
только оператор корневой ноды (в данном случае SELECT). 
Когда план удаляется из кэша, он также удаляется из статистики sys.dm_exec_query_plan_stats.
Наконец, если план не может быть сохранен в кэше, то он не будет доступен и через DMV.

Query Store (Хранилище запросов)

Более подробно мы рассмотрим Query Store в главе 6. Однако мы можем вкратце
рассмотреть, как получить план выполнения из Query Store. Существуют системные таблицы,
в которых хранится информация для Query Store. Мы можем получать информацию из них
точно так же, как и из любых других, как показано в Листинге 4-5.

Листинг 4-5. Получение плана из хранилища запросов 

```SQL
SELECT 
	qsq.query_id, 
	qsq.query_hash, 
	CAST(qsp.query_plan AS XML) AS QueryPlan 
FROM sys.query_store_query AS qsq 
	JOIN sys.query_store_plan AS qsp 
		ON qsp.query_id = qsq.query_id 
	JOIN sys.query_store_query_text AS qsqt 
		ON qsqt.query_text_id = qsq.query_text_id 
WHERE qsqt.query_sql_text LIKE 'SELECT soh.SalesOrderNumber, p.Name, %';
```

Как и в запросе DMV, я использовал LIKE только для экономии места. Это не лучший способ
фильтрации запросов в хранилище запросов. Я добавил CAST к XML, чтобы получить план, 
который можно открыть в SSMS. Query Store хранит XML-данные в столбце VARCHAR(MAX), 
чтобы не хранить их дважды. Вы все еще можете столкнуться с ограничением на 
вложенность XML, но для большинства запросов это будет работать нормально. Результаты 
показаны на рис. 4-7.

![[Figure 4-7.png]]

Рисунок 4-7. Получение плана выполнения из Query Store 

Открыв план, вы увидите то же самое, что и на рис. 4-2. В Query Store не хранятся отдельные 
метрики времени выполнения. Как уже было сказано, для их получения необходимо 
выполнить запрос и снять план или использовать sys.dm_exec_query_plan_stats.

