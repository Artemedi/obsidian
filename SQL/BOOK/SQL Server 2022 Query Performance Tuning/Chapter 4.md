## Анализ поведения запросов Using Execution Plans ("Использование планов выполнения")  
  
Планы выполнения - это лучшее средство для понимания того, что выбирает оптимизатор запросов, пытаясь обеспечить высокую скорость выполнения запроса. Планы выполнения точно описывают поведение запроса, начиная с типов операций объединения и заканчивая используемыми индексами, а также способы их использования. Планы выполнения не являются абсолютным показателем производительности. Это должно быть предельно ясно.  
В этой главе мы расскажем о том, что такое планы выполнения, как они выглядят и как их читать. Для этого мы рассмотрим следующие темы:  
  
- Как захватывать планы выполнения  
- Разница между Actual("фактический") и Estimated("предполагаемый") планами  
- Что следует искать в планах выполнения  
- Что означают некоторые операторы  
- Доступные инструменты, помогающие в работе с планами выполнения

Планы выполнения - это обширная тема. В этой главе я расскажу о некоторых особенностях их использования, а затем буду использовать их на протяжении всей книги, когда мы будем учиться настраивать запросы с помощью понимания поведения, демонстрируемого планами выполнения.  
  
Сами планы выполнения являются общими для всех платформ данных SQL Server. План, созданный в Azure SQL Database, SQL Server 2022, AWS RDS или Azure Managed Instance, будет таким же, как и любой другой. Это делает их универсальным инструментом для понимания поведения запросов.

## Предполагаемые или Фактические Планы Выполнения  
  
Давайте начнем с самой актуальной темы и разберемся с ней. В следующем разделе я расскажу о методах, используемых для получения планов выполнения. Одним из таких способов является использование SQL Server Management Studio (SSMS). SSMS показывает нам два различных вида планов: Estimated("предполагаемый") и Actual("фактический"). Проблема в том, что это неточные названия. Существует только один вид плана выполнения. Однако можно запустить запрос и заставить SQL Server зафиксировать определенные метрики времени работы в плане выполнения этого запроса. Именно этот план выполнения с добавлением метрик рабочего времени и называется "фактическим планом выполнения".  
Это противоречит многолетней документации, в том числе и той, которую я написал сам. Однако это абсолютно верно. Как мы увидим в следующем разделе и на протяжении всей книги, мы будем получать планы выполнения из самых разных источников: из Dynamic Management Views("Представления Динамического Управления"), Extended Events, Query Store и других. Все эти планы для данного запроса без перекомпиляции будут идентичны. Однако если мы выполним запрос и снимем метрики во время выполнения, то этот план также будет идентичным. Он просто будет содержать дополнительную информацию.

Добавленная информация, а именно метрики рабочего времени, - это отличные данные, и мы собираемся их использовать. Эта информация включает, но не ограничивается следующим:  
  
- Статистика ожидания для запроса  
- Длительность запроса  
- Фактическое количество строк  
- Фактическое количество выполненных операторов  
  
Однако это лишь дополнительные данные. Сам план всегда один и тот же (за исключением случаев перекомпиляции, которые мы подробно рассмотрим в главе 14). Чаще всего, если есть возможность, старайтесь фиксировать план выполнения с помощью метрик времени выполнения. Дополнительная информация часто оказывается полезной. Однако, поскольку в рабочей среде иногда не удается выполнить запросы не стесняйтесь использовать план выполнения не содержащий метрик времени выполнения. Это может быть единственным доступным инструментом.

## Захват Планов Выполнения  
  
Существует несколько методов захвата планов выполнения. Самый простой - использовать SSMS для получения плана выполнения без выполнения запроса или плана выполнения с метрикой времени работы после выполнения запроса. Можно также извлекать запросы непосредственно из кэша плана в памяти с помощью DMV. Если для данной базы данных включен Query Store, то в нем также будут содержаться планы выполнения. Наконец, для получения различных планов выполнения можно использовать Extended Events.  
Прежде чем мы приступим к рассмотрению деталей, несколько замечаний о захвате планов выполнения. Захват метрик времени выполнения с планом выполнения является дорогостоящей операцией. Кроме того, этот процесс будет напрямую и негативно влиять на время выполнения запроса и использование ресурсов. В связи с этим следует взять за привычку либо перехватывать план выполнения, либо перехватывать метрики времени выполнения. Не стоит делать и то, и другое одновременно.  
За графическим планом выполнения, который мы будем использовать на протяжении всей книги, находится XML. Именно так он хранится в памяти, в Query Store, и так он будет у большинства методов получения плана. Существует способ получения так называемого "текстового плана", но он не так полезен, поэтому здесь мы его рассматривать не будем.  
Наконец, существует способ захвата плана в Azure Data Studio. Однако на момент написания этой статьи планы в ней были крайне неполными, поэтому мы не будем их здесь использовать.

## SQL Server Management Studio 

В SSMS можно захватить план выполнения, а можно выполнить запрос и получить как план выполнения, так и метрики времени выполнения. В качестве примера возьмем простой запрос, который мы будем использовать на протяжении всей главы, чтобы не публиковать графический план более одного раза. В листинге 4-1 показан наш пример запроса.

Листинг 4-1. Простой запрос для иллюстрации планов выполнения

```sql
SELECT 
	soh.SalesOrderNumber, 
	p.Name, 
	sod.OrderQty 
FROM Sales.SalesOrderHeader AS soh 
	JOIN Sales.SalesOrderDetail AS sod ON sod.SalesOrderID = soh.SalesOrderID
	JOIN Production.Product AS p ON p.ProductID = sod.ProductID 
WHERE soh.CustomerID = 30052;
```

Чтобы увидеть план выполнения мы нажмем кнопку на панели инструментов SQL Editor. Однако перед этим необходимо выделить запрос из Листинга 4-1. В пакетной обработке каждый запрос получает свой план выполнения. Поэтому, если мы хотим видеть только один план выполнения, выделите этот текст. В противном случае будет получен план для каждого запроса в пакете.  
Кнопка, которую мы собираемся нажать после выделения нашего запроса, показана на рис. 4-1 с рамкой вокруг нее. Она также имеет всплывающую подсказку: "Отобразить предполагаемый план выполнения".

![[Figure 4-1.png]]

Рисунок 4-1. Панель инструментов SQL Editor с выделенной кнопкой Display estimated execution plan

Это же действие можно выполнить с помощью клавиатуры, набрав CTL-L. После нажатия кнопки или сочетания клавиш вы сразу же увидите план выполнения на отдельной вкладке в панели результатов в окне запроса SSMS, как показано на рис. 4-2.

![[Figure 4-2.png]]

Рисунок 4-2. Выделенный запрос и план его выполнения

Мы рассмотрим объекты называемые операторами в плане выполнения позже в этой главе. На данный момент вы получили свой первый план выполнения.

Чтобы добавить метрики времени выполнения в план, мы должны выполнить запрос, но для этого необходимо сделать одно действие. Мы должны включить возможность захвата метрик времени выполнения с помощью другой кнопки на панели инструментов SQL Editor, выделенной на рисунке 4-3 в положении on.

![[Figure 4-3.png]]

Рисунок 4-3. Панель инструментов SQL Editor с выделенной кнопкой Include actual execution plan

В подсказке к кнопке написано "Включить реальный план выполнения". Включить или выключить ее можно также с клавиатуры, набрав CTL-M. В отличие от первого плана выполнения, здесь ничего не происходит, кроме того, что кнопка отображается в нажатом состоянии. Опять же, чтобы увидеть план выполнения и метрики времени выполнения, необходимо выполнить запрос. После выполнения запроса в панели результатов появится та же вкладка Execution plan (План выполнения), как показано на рис. 4-4. Однако вкладка результатов будет открыта по умолчанию, поэтому для просмотра плана выполнения необходимо щелкнуть на этой вкладке.

![[Figure 4-4.png]]

Рисунок 4-4. План выполнения с метриками времени выполнения

Видно, что, хотя основная форма плана и количество объектов в нем остались прежними, была добавлена дополнительная информация. Эта дополнительная информация - метрики времени выполнения, добавленные к каждому оператору в плане.

Dynamic Management Views("Представления Динамического Управления")  
  
В главе 3 мы уже рассказывали о захвате планов выполнения с помощью DMV на приведенных там примерах. Тем не менее, нам следует немного расширить эту тему. Во-первых, давайте добавим к нашему запросу из главы 3 предложение WHERE, чтобы можно было найти только тот запрос, который выполняется в данный момент.  
В листинге 4-2 показано предложение WHERE.

Листинг 4-2. Фильтрация по определенному запросу
